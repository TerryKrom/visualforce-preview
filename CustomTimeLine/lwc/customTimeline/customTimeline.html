<template>
  <div class="slds-timeline">
    <!-- Se há dados -->
    <template if:true={hasData}>

      <!-- Upcoming & Overdue -->
      <template if:true={data.UpcomingOverdue.items.length}>
        <section class="slds-timeline__section upcoming">
          <header class="slds-timeline__header">
            Upcoming &amp; Overdue
          </header>
          <ul class="slds-timeline__list">
            <template for:each={data.UpcomingOverdue.items} for:item="item">
              <li key={item.id} class="slds-timeline__item">
                <div class="slds-media">
                  <div class="slds-media__figure">
                    <lightning-icon icon-name={item.icon} size="small"></lightning-icon>
                  </div>
                  <div class="slds-media__body">
                    <h3>
                      <a href={item.link}>{item.title}</a>
                    </h3>
                    <p class="slds-timeline__detail">
                      <span>{item.type}</span>
                      <template if:true={item.owner}> • {item.owner}</template>
                      <template if:true={item.dueLabel}> • {item.dueLabel}</template>
                    </p>
                  </div>
                </div>
              </li>
            </template>
          </ul>
        </section>
      </template>

      <!-- Botão “Send Email” acima das seções por mês -->
      <div class="slds-grid slds-grid_align-spread slds-p-vertical_small">
        <span></span>
        <lightning-button-icon
          icon-name="utility:email"
          variant="bare"
          size="large"
          alternative-text="Send Email"
          title="Send Email"
          onclick={handleSendEmail}>
        </lightning-button-icon>
      </div>

      <!-- Seções agrupadas por mês -->
      <template for:each={data.Timeline} for:item="sec">
        <section key={sec.label} class="slds-timeline__section" data-month={sec.label}>
          <header class="slds-timeline__header">
            <div class="left-label">
              <template if:true={sec.isOpen}>
                <lightning-icon
                  data-month={sec.label}
                  style="padding:3px 5px; cursor:pointer;"
                  icon-name="utility:chevrondown"
                  size="x-small"
                  onclick={handleIsAccordeonOpen}>
                </lightning-icon>
              </template>
              <template if:false={sec.isOpen}>
                <lightning-icon
                  data-month={sec.label}
                  style="padding:3px 5px; cursor:pointer;"
                  icon-name="utility:chevronright"
                  size="x-small"
                  onclick={handleIsAccordeonOpen}>
                </lightning-icon>
              </template>
              <span>{sec.label}</span>
            </div>
            <span class="right-label">{sec.subLabel}</span>
          </header>

          <template if:true={sec.isOpen}>
            <ul class="slds-timeline__list">
              <template for:each={sec.items} for:item="item">
                <li key={item.id} class="slds-timeline__item">
                  <div class="slds-media">
                    <div class="slds-media__figure">
                      <template if:true={item.isOpened}>
                        <lightning-icon
                          data-id={item.id}
                          style="padding:3px 5px; cursor:pointer;"
                          icon-name="utility:chevrondown"
                          size="x-small"
                          onclick={handleEmailClose}>
                        </lightning-icon>
                      </template>
                      <template if:false={item.isOpened}>
                        <lightning-icon
                          data-id={item.id}
                          style="padding:3px 5px; cursor:pointer;"
                          icon-name="utility:chevronright"
                          size="x-small"
                          onclick={handleEmailOpen}>
                        </lightning-icon>
                      </template>
                      <lightning-icon icon-name={item.icon} size="small"></lightning-icon>
                    </div>
                    <div class="slds-media__body">
                      <h3>
                        <a href={item.link}>{item.title}</a>
                      </h3>
                      <p class="slds-timeline__detail">
                        <span>{item.type}</span>
                        <template if:true={item.owner}> • {item.owner}&nbsp;</template>
                        • {item.formattedDate}
                      </p>
                    </div>
                  </div>

                  <template if:true={item.isOpened}>
                    <div class="slds-p-around_small emailbody">
                      <div class="emaildisplay">
                        <a href={item.fromEmailHref} data-link={item.fromEmail}>
                          {item.fromEmail}&nbsp;
                        </a>
                        sent an email to&nbsp;
                        <a href={item.toEmailHref} data-link={item.toEmail}>
                          {item.toEmail}
                        </a>
                      </div>
                      <div class="grey-container">
                        <div class="display-email">
                          <span>From Address</span>
                          <a href={item.fromEmailHref}>{item.fromEmail}</a>
                        </div>
                        <div class="display-email">
                          <span>To Address</span>
                          <a href={item.toEmailHref}>{item.toEmail}</a>
                        </div>
                      </div>
                      <template if:true={item.isHtml}>
                        <span class="email-preview-label">Email HTML</span>
                        <iframe
                          src={item.iframeUrl}
                          class="email-frame"
                          width="100%"
                          height="400px"
                          frameborder="0"
                          scrolling="auto">
                        </iframe>
                      </template>
                      <template if:false={item.isHtml}>
                        <div class="grey-container">
                          <div class="display-body">
                            <span>Email body</span>
                            {item.body}
                          </div>
                        </div>
                      </template>
                    </div>
                  </template>

                  <lightning-button-menu
                    class="edit"
                    data-id={item.id}
                    alternative-text="Show actions"
                    onselect={handleAction}
                    menu-alignment="auto"
                    icon-name="utility:down"
                    size="xx-small">
                    <lightning-menu-item value="edit"  label="Editar"></lightning-menu-item>
                    <lightning-menu-item value="delete" label="Deletar"></lightning-menu-item>
                  </lightning-button-menu>
                </li>
              </template>
            </ul>
          </template>
        </section>
      </template>

    </template>

    <!-- Se não há dados -->
    <template if:false={hasData}>
      <div class="slds-p-around_medium slds-align_absolute-center">
        No activity found.
      </div>
    </template>
  </div>

  <!-- Modal de confirmação -->
  <template if:true={showConfirmModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
      <div class="slds-modal__container">
        <header class="slds-modal__header">
          <h2 class="slds-modal__title">Confirm delete</h2>
        </header>
        <div class="slds-modal__content slds-p-around_medium">
          Delete this email?
        </div>
        <footer class="slds-modal__footer">
          <lightning-button
            label="Cancel"
            onclick={cancelDelete}
            class="slds-m-right_small">
          </lightning-button>
          <lightning-button
            variant="destructive"
            label="Delete"
            onclick={confirmDelete}>
          </lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>
</template>